## 최적화는 신중히 하라

### 최적화 격언

```
💡

(맹목적인 어리석음을 포함해) 그 어떤 핑계보다 효율성이라는 이름 아래 행해진 컴퓨팅 죄악이 더 많다(심지어 효율을 높이지도 못하면서).

(전체의 97% 정도만) 자그마한 효율성은 모두 잊자. 섣부른 최적화가 만악의 근원이다.

최적화를 할 때는 다음 두 규칙을 따르라.
첫 번째, 하지 마라.
두 번째, (전문가 한정) 아직 하지 마라. 다시 말해, 완전히 명백하고 최적화되지 않은 해법을 찾을 때까지는 하지 마라.

```

### 빠른 프로그램보다는 좋은 프로그램

- 섣부른 최적화는 좋지 않다.
- 빠른 프로그램 보다는 좋은 프로그램을 작성하는게 1순위다.
    - 견고한 구조
- 좋은 프로그램을 작성한 후에 성능을 높이려면 아키텍처 단에서 최적화할 수 있는 방법을 찾아보자
- 좋은 프로그램은 정보 은닉 원칙을 따르므로 개별 구성 요소의 내부를 독립적으로 설계할 수 있다. 따라서 시스템의 영향도를 최소화하고 각 요소를 다시 설계할 수 있다.

### 성능 올리는 방법

- 그렇다고 프로그램을 완성할 때 성능 문제를 무시하라는건 아니다
- 구현상의 문제는 나중에 최적화해 해결할 수 있지만, 아키텍처의 결함이 성능을 제한하는 상황이라면 시스템 전체를 다시 작성하지 않고는 해결하기 불가능할 수도 있다.
- 따라서, 설계 단계에서는 성능을 반드시 염두에 두어야 한다.

#### 1. 성능을 제한하는 설계를 피하라

- 완성 후 변경하기가 가장 어려운 설계 요소는 컴포넌트끼리, 혹은 외부 시스템과의 소통 방식이다.
- API 네트워크 프로토콜, 영구 저장용 데이터 포맷 등이 대표적이다.

    1.	**API**: 시스템 간 소통 규칙. REST, SOAP, GraphQL 등.

    2.	**네트워크 프로토콜**: 데이터 전송을 위한 표준. HTTP, TCP, WebSocket 등.

    3.	**데이터 포맷**: 데이터 저장 및 교환 형식. JSON, XML, CSV 등.


#### 2. API를 설계할 때 성능에 주는 영향을 고려하라.

- 가변으로 클래스를 설계하면 불필요한 방어적 복사를 수없이 유발할 수 있다(아이템 50)
    - 요즘 VM이여도 수백만개를 생성해야 한다면 이야기는 달라진다
- 컴포지션으로 해결할 수 있음에도 상속 방식으로 설계한 public 클래스는 상위 클래스에 영원히 종속되며 성능 제약까지도 물려받게 된다.
- 인터페이스도 있는데 굳이 구현 타입을 사용하면 특정 구현체에 종속되게 하여,나중에 더 빠른 구현체가 나오더라도 이용하지 못하게 된다.

#### 잘 설계된 API는 성능도 좋다

- 잘 설계된 API는 성능도 좋다
- 성능을 위해 API를 왜곡하는 것은 매우 안 좋은 생각이다”
    - **API의 본래 목적이나 설계 원칙을 무시하거나 변경하여 성능을 개선하려고 시도하는 것은 좋지 않다**

### 성능 측정

- 최적화 시도 전후로 성능을 측정하라
- 최적화 결과가 더 안좋게 나오거나 미비한 경우도 있을 것이다.
- 주요 원인은 어디가 원인인지 추측하기 어렵기 때문이다.

#### 프로파일링 도구

- 프로파일링 도구는 최적화 영역을 찾는데 도움을 준다

<aside>
💡

**프로파일링 (Profiling)**

•	**목적**: 애플리케이션이나 코드 내부의 세부적인 성능 문제를 분석.

•	**범위**: 메소드 호출 시간, 메모리 사용량, CPU 사용량 등 세부적인 정보를 실시간으로 분석.

•	**도구**: JProfiler, VisualVM, Async Profiler 등.

•	**주요 질문**:

•	“어떤 코드가 가장 많은 CPU 시간을 사용하는가?”

•	“어떤 함수가 병목 현상을 초래하는가?”

•	“메모리 누수가 발생하는 위치는 어디인가?”

</aside>

- 시스템 규모가 커질수록 프로파일러가 더 중요해진다.

#### 자바의 성능 측정 예민함

- 자바는 성능 모델이 덜 정교해서 성능 측정의 중요성이 크다
- 자바는 기본 연산에 드는 상대적인 비용을 덜 명확하게 정의하고 있다.
    - 프로그래머가 작성하는 코드와 CPU에서 수행하는 명령 사이의 ‘추상화 격차’가 커서 최적화로 인한 성능 변화를 일정하게 예측하기가 어렵다.
- 자바의 성능 측정 결과는 자바 플랫폼이나 하드웨어 플랫폼의 정류마다 차이가 있기 때문에 환경이 다르다면 각각 측정해야 한다

### 핵심 정리

```
💡
빠른 프로그램보단 좋은 프로그램을 작성하다보면 성능은 따라오게 마련이다. 시스템을 설계할 때는 성능을 염두에 두어야 한다.
구현을 완료했다면 성능 측정을 해라. 충분히 빠르면 그걸로 만족해 하고, 그렇지 않다면 프로파일러를 사용해 원인을 찾고 최적화를 수행하라.
```