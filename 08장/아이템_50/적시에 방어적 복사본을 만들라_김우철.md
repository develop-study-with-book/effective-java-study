## ì ì‹œì— ë°©ì–´ì  ë³µì‚¬ë³¸ì„ ë§Œë“¤ë¼

### ìë°”ëŠ” ë¶ˆë³€ì‹ì— ì™„ë²½í•˜ê²Œ ë°©ì–´í•  ìˆ˜ ìˆì§€ ì•Šë‹¤

- ìë°”ëŠ” ë©”ëª¨ë¦¬ë¥¼ ì§ì ‘ ë‹¤ë£¨ì§€ ì•Šê¸° ë•Œë¬¸ì— C, C++ì–¸ì–´ ë³´ë‹¤ëŠ” ì•ˆì „í•œ í¸ì— ì†í•œë‹¤.
- ê·¸ë ‡ì§€ë§Œ í´ë¼ì´ì–¸íŠ¸ê°€ ì•…ì˜ì ì´ë“  ì‹¤ìˆ˜ë“  ë¶ˆë³€ì‹ì„ ê¹¨ëœ¨ë¦´ ìˆ˜ ìˆë‹¤ê³  ê°€ì •í•˜ê³  ë°©ì–´ì ìœ¼ë¡œ í”„ë¡œê·¸ë˜ë° í•´ì•¼ í•œë‹¤.

#### ë¶ˆë³€ì‹ ê¹¨ëœ¨ë¦¬ëŠ” ì˜ˆì‹œ

- ë³´í†µ ê°ì²´ì˜ í—ˆë½ ì—†ì´ëŠ” ì™¸ë¶€ì—ì„œ ë‚´ë¶€ë¥¼ ìˆ˜ì •í•˜ëŠ” ì¼ì€ ë¶ˆê°€ëŠ¥ í•˜ì§€ë§Œ ì£¼ì˜ë¥¼ ê¸°ìš¸ì´ì§€ ì•Šìœ¼ë©´ ë‚´ë¶€ë¥¼ ìˆ˜ì •í•˜ë„ë¡ í—ˆë½í•˜ëŠ” ê²½ìš°ê°€ ìƒê¸´ë‹¤.

```java
import java.util.Date;

public final class Period {
    private final Date start;
    private final Date end;

    /**
     * @param start ì‹œì‘ ì‹œê°
     * @param end ì¢…ë£Œ ì‹œê°; ì‹œì‘ ì‹œê°ë³´ë‹¤ ë’¤ì—¬ì•¼ í•œë‹¤.
     * @throws IllegalArgumentException ì‹œì‘ ì‹œê°ì´ ì¢…ë£Œ ì‹œê°ë³´ë‹¤ ëŠ¦ì„ ë•Œ ë°œìƒí•œë‹¤.
     * @throws NullPointerException startë‚˜ endê°€ nullì´ë©´ ë°œìƒí•œë‹¤.
     */
    public Period(Date start, Date end) {
        if (start.compareTo(end) > 0) {
            throw new IllegalArgumentException("Start date must be before end date");
        }
        this.start = start;
        this.end = end;
    }

    public Date getStart() {
        return start;
    }

    public Date getEnd() {
        return end;
    }
}
```

```java
public class PeriodAttack {
    public static void main(String[] args) {
        Date start = new Date();
        Date end = new Date();
        Period period = new Period(start, end);

        // ì‹œì‘ ë‚ ì§œë¥¼ ì¢…ë£Œ ë‚ ì§œ ì´í›„ë¡œ ìˆ˜ì •(ì—¬ê¸°ì„œ ë¶ˆë³€ì‹ ê¹¨ì§)
        period.getEnd().setYear(78);  // 1978ë…„ìœ¼ë¡œ ì„¤ì •

        System.out.println("Start: " + period.getStart());
        System.out.println("End: " + period.getEnd());

        // ë¶ˆë³€ì‹ì´ ê¹¨ì¡ŒëŠ”ì§€ í™•ì¸
        if (period.getStart().after(period.getEnd())) {
            System.out.println("ë¶ˆë³€ì‹ì´ ê¹¨ì¡ŒìŠµë‹ˆë‹¤!");
        }
    }
}
```

```java
Start: Tue Jan 23 15:30:00 KST 2024
End: Sat Jan 23 15:30:00 KST 1978
ë¶ˆë³€ì‹ì´ ê¹¨ì¡ŒìŠµë‹ˆë‹¤!
```

- `period.getEnd().setYear(78);` ì—ì„œ Period ë‚´ë¶€ ìˆ˜ì •ì„ í—ˆìš©í–ˆê¸° ë•Œë¬¸ì— ë¶ˆë³€ì‹ì´ ê¹¨ì¡Œë‹¤.
- ì°¸ê³ ë¡œ DateëŠ” ê°€ë³€ì´ê³  ë‚¡ì€ APIì´ë‹ˆ Instant, LocalDateTime, ZonedDateTime ê°™ì€ ë¶ˆë³€ ê°ì²´ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.

### ìƒì„±ìì— ë°©ì–´ì  ë³µì‚¬(defensive copy)

- Period ì¸ìŠ¤í„´ìŠ¤ ë‚´ë¶€ë¥¼ ë³´í˜¸í•˜ë ¤ë©´ ìƒì„±ìì—ì„œ ë°›ì€ ê°€ë³€ ë§¤ê°œë³€ìˆ˜ ê°ê°ì„ ë°©ì–´ì ìœ¼ë¡œ ë³µì‚¬í•´ì•¼ í•œë‹¤.
- Period ì¸ìŠ¤í„´ìŠ¤ ì•ˆì—ì„œëŠ” ì›ë³¸ì´ ì•„ë‹Œ ë³µì‚¬ë³¸ì„ ì‚¬ìš©í•œë‹¤.

```java
ì½”ë“œ 50-3 ìˆ˜ì •í•œ ìƒì„±ì - ë§¤ê°œë³€ìˆ˜ì˜ ë°©ì–´ì  ë³µì‚¬ë³¸ì„ ë§Œë“ ë‹¤.

public Period(Date start, Date end) {
    this.start = new Date(start.getTime());
    this.end = new Date(end.getTime());

    if (this.start.compareTo(this.end) > 0)
        throw new IllegalArgumentException(
            this.start + "ê°€ " + this.end + "ë³´ë‹¤ ëŠ¦ë‹¤.");
}
```

- ë°©ì–´ì  ë³µì‚¬ë³¸ì„ ë¨¼ì € ë§Œë“¤ê³ , ì´ ë³µì‚¬ë³¸ìœ¼ë¡œ ìœ íš¨ì„±ì„ ê²€ì‚¬í•´ì•¼ í•œë‹¤.
- ë©€í‹° ìŠ¤ë ˆë”© í™˜ê²½ì—ì„œ ìœ íš¨ì„± ê²€ì‚¬ë¥¼ ë¨¼ì € í•œê³  ë³µì‚¬ë³¸ì„ ë§Œë“œëŠ” ê·¸ ì°°ë‚˜ì— ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ì›ë³¸ ê°ì²´ë¥¼ ìˆ˜ì •í•  ìœ„í—˜ì´ ìˆë‹¤.
    - ì´ëŸ¬í•œ ê³µê²©ì„ (ê²€ì‚¬ì‹œì /ì‚¬ìš©ì‹œì  ê³µê²©) í˜¹ì€ TOCTOU ê³µê²©ì´ë¼ í•œë‹¤
- Date í´ë˜ìŠ¤ì˜ clone() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•´ì„œ ë³µì œí•˜ì§€ ì•Šì•˜ë‹¤.
    - ë§¤ê°œë³€ìˆ˜ê°€ ì œ 3ìì— ì˜í•´ í™•ì¥ë  ìˆ˜ ìˆëŠ” íƒ€ì…ì´ë¼ë©´, clone()ì„ ì‚¬ìš©í•˜ì§€ ë§ì•„ì•¼ í•œë‹¤.
    - Date í´ë˜ìŠ¤ëŠ” finalì´ ì•„ë‹ˆë¯€ë¡œ, ì•…ì˜ì ì¸ í•˜ìœ„ í´ë˜ìŠ¤ê°€ clone()ì„ ì˜¤ë²„ë¼ì´ë“œí•˜ì—¬ ì›ë³¸ ê°ì²´ì˜ ì°¸ì¡°ë¥¼ ë°˜í™˜í•  ìˆ˜ ìˆë‹¤.
    - **ê²°ë¡ ì€ ìƒì† ê°€ëŠ¥í•œ í´ë˜ìŠ¤ë¥¼ ë‹¤ë£° ë•ŒëŠ” clone() ë³´ë‹¨ ìƒˆ ê°ì²´ë¥¼ ìƒì„±í•˜ì**

```java
// ì•…ì˜ì ì¸ Date í•˜ìœ„ í´ë˜ìŠ¤
class EvilDate extends Date {
    static Date originalDate;

    public EvilDate(long time) {
        super(time);
    }

    @Override
    public Object clone() {
        // ì›ë³¸ Date ê°ì²´ì˜ ì°¸ì¡°ë¥¼ ì €ì¥
        originalDate = this;
        // ìê¸° ìì‹ ì„ ë°˜í™˜í•˜ì—¬ ë³µì œ ëŒ€ì‹  ê°™ì€ ê°ì²´ë¥¼ ë°˜í™˜
        return this;
    }
}

// Period í´ë˜ìŠ¤ (ì·¨ì•½í•œ ë²„ì „)
class Period {
    private final Date start;
    private final Date end;

    public Period(Date start, Date end) {
        // ì·¨ì•½í•œ ë°©ì–´ì  ë³µì‚¬
        this.start = (Date) start.clone();
        this.end = (Date) end.clone();
    //..
    
}

public class DateVulnerabilityDemo {
    public static void main(String[] args) {
        EvilDate evilStart = new EvilDate(System.currentTimeMillis());
        Date normalEnd = new Date(System.currentTimeMillis() + 86400000); // 1ì¼ í›„

        Period period = new Period(evilStart, normalEnd);

        // EvilDate.originalDateëŠ” ì´ì œ Period ë‚´ë¶€ì˜ 'start' í•„ë“œë¥¼ ì°¸ì¡°
        System.out.println("Original start: " + period.start());
        
        // Period ê°ì²´ì˜ ë‚´ë¶€ ìƒíƒœë¥¼ ì§ì ‘ ë³€ê²½
        EvilDate.originalDate.setYear(130); // 2030ë…„ìœ¼ë¡œ ë³€ê²½

        System.out.println("Modified start: " + period.start());
    }
}
```
- main ë©”ì„œë“œì—ì„œ EvilDate.originalDateë¥¼ ìˆ˜ì •í–ˆëŠ”ë° period ë‚´ë¶€ì— ì˜í–¥ì„ ë¼ì³¤ë‹¤.
- ì›ì¸ì€, `EvilDate`ì˜ clone ë©”ì„œë“œê°€ ìê¸° ìì‹ ì„ ë°˜í™˜í–ˆê¸° ë•Œë¬¸ì´ë‹¤.

### getterì— ë°©ì–´ì  ë³µì‚¬(defensive copy)

- getter ì ‘ê·¼ìì—ì„œ í•„ë“œ ë°˜í™˜ì‹œ ë°©ì–´ì  ë³µì‚¬ë³¸ì„ ë°˜í™˜í•˜ë©´ ëœë‹¤.

```java
ì½”ë“œ 50-5 ìˆ˜ì •í•œ ì ‘ê·¼ì - í•„ë“œì˜ ë°©ì–´ì  ë³µì‚¬ë³¸ì„ ë°˜í™˜í•œë‹¤.

public Date start() {
    return new Date(start.getTime());
}

public Date end() {
    return new Date(end.getTime());
}
```

- ìƒì„±ìì™€ ë‹¬ë¦¬ ì ‘ê·¼ì ë©”ì„œë“œì—ëŠ” ë°©ì–´ì  ë³µì‚¬ì— cloneì„ ì‚¬ìš©í•´ë„ ëœë‹¤.
    - Periodê°€ ê°€ì§€ê³  ìˆëŠ” Date ê°ì²´ëŠ” java.util.Dateì„ì´ í™•ì‹¤í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

### ê²°ë¡ 

- ë˜ë„ë¡ ë¶ˆë³€ ê°ì²´ë“¤ì„ ì¡°í•©í•´ ê°ì²´ë¥¼ êµ¬ì„±í•´ì•¼ ë°©ì–´ì  ë³µì‚¬ë¥¼ í•  ì¼ì´ ì¤„ì–´ ë“ ë‹¤.
- í˜¸ì¶œìê°€ ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ë¥¼ ìˆ˜ì •í•˜ì§€ ì•Šìœ¼ë¦¬ë¼ í™•ì‹ í•˜ë©´ ë°©ì–´ì  ë³µì‚¬ë¥¼ ìƒëµí•  ìˆ˜ ìˆë‹¤.
    - í•˜ì§€ë§Œ, ìˆ˜ì •í•˜ì§€ ë§ì•„ì•¼ í•¨ì„ ëª…í™•íˆ ë¬¸ì„œí™”í•˜ëŠ”ê²Œ ì¢‹ë‹¤.
- ê°„í˜¹, í´ë¼ì´ì–¸íŠ¸ê°€ ê°ì²´ì˜ í†µì œê¶Œì„ ëª…ë°±íˆ ì´ì „í•  ëª©ì ì´ë©´ í•­ìƒ ë°©ì–´ì  ë³µì‚¬ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ëœë‹¤. ë¬¸ì„œí™”ë§Œ í™•ì‹¤íˆ ê¸°ì¬í•˜ë©´ ëœë‹¤.

#### ë°©ì–´ì  ë³µì‚¬ë¥¼ ìƒëµí•´ë„ ë˜ëŠ” ìƒí™©

- í•´ë‹¹ í´ë˜ìŠ¤ì™€ ê·¸ í´ë¼ì´ì–¸íŠ¸ê°€ ìƒí˜¸ ì‹ ë¢°í•  ìˆ˜ ìˆì„ë•Œ
- ë¶ˆë³€ì‹ì´ ê¹¨ì§€ë”ë¼ë„ ê·¸ ì˜í–¥ì´ ì˜¤ì§ í˜¸ì¶œí•œ í´ë¼ì´ì–¸íŠ¸ë¡œ êµ­í•œë  ë•Œë¡œ í•œì •
    - ë˜í¼ í´ë˜ìŠ¤ íŒ¨í„´(ì•„ì´í…œ 18)
        - í´ë¼ì´ì–¸íŠ¸ëŠ” ë˜í¼ì— ë„˜ê¸´ ê°ì²´ì— ì—¬ì „íˆ ì§ì ‘ ì ‘ê·¼í•˜ì—¬ ë˜í¼ì˜ ë¶ˆë³€ì‹ì„ ì‰½ê²Œ íŒŒê´´í•  ìˆ˜ ìˆì§€ë§Œ ê·¸ ì˜í–¥ì„ ì˜¤ì§ í´ë¼ì´ì–¸íŠ¸ ìì‹ ë§Œ ë°›ê²Œ ëœë‹¤.
        - (ë‚´ ìƒê°) í´ë¼ì´ì–¸íŠ¸ê°€ ë˜í¼ì˜ ë¶ˆë³€ì‹ì„ íŒŒê´´í•œ ë’¤, ë³€ì¡°ëœ ë°ì´í„°ê°€ ë‹¤ë¥¸ ì½”ë“œì—ì„œ ë°›ì•„ì„œ ì‚¬ìš©í•˜ë©´ ì˜í–¥ì„ ë¼ì¹˜ëŠ”ê²Œ ì•„ë‹Œê°€?

```java
public class MutableObject {
    private int value;
    
    public MutableObject(int value) {
        this.value = value;
    }
    
    public void setValue(int value) {
        this.value = value;
    }
    
    public int getValue() {
        return value;
    }
}

public class ImmutableWrapper {
    private final MutableObject obj;
    
    public ImmutableWrapper(MutableObject obj) {
        this.obj = obj;  // ë°©ì–´ì  ë³µì‚¬ë¥¼ í•˜ì§€ ì•ŠìŒ
    }
    
    public int getValue() {
        return obj.getValue();
    }
}

public class Client {
    public static void main(String[] args) {
        MutableObject mutable = new MutableObject(10);
        ImmutableWrapper wrapper = new ImmutableWrapper(mutable);
        
        System.out.println(wrapper.getValue());  // ì¶œë ¥: 10
        
        // í´ë¼ì´ì–¸íŠ¸ê°€ ì›ë³¸ ê°ì²´ë¥¼ ë³€ê²½
        mutable.setValue(20);
        
        System.out.println(wrapper.getValue());  // ì¶œë ¥: 20
        // ë˜í¼ì˜ "ë¶ˆë³€ì„±"ì´ ê¹¨ì¡Œì§€ë§Œ, ì´ëŠ” ì´ í´ë¼ì´ì–¸íŠ¸ ì½”ë“œì—ë§Œ ì˜í–¥ì„ ë¯¸ì¹¨
        // ê·¸ëŸ¬ë‚˜, wrapper.getValue())ë¥¼ ë‹¤ë¥¸ë°ì„œ ì‚¬ìš©í•œë‹¤ë©´ ì˜í–¥ì„
        // ë¯¸ì¹˜ëŠ”ê²Œ ì•„ë‹Œê°€?
    }
}
```

### í•µì‹¬ì •ë¦¬

```
ğŸ’¡
í´ë˜ìŠ¤ê°€ í´ë¼ì´ì–¸íŠ¸ë¡œë¶€í„° ë°›ëŠ” í˜¹ì€ ë°˜í™˜í•˜ëŠ” êµ¬ì„±ìš”ì†Œê°€ ê°€ë³€ì´ë¼ë©´ ë°˜ë“œì‹œ ë°©ì–´ì ìœ¼ë¡œ ë³µì‚¬í•´ì•¼ í•œë‹¤.
ë³µì‚¬ ë¹„ìš©ì´ ë„ˆë¬´ í¬ê±°ë‚˜ clientê°€ ê·¸ ìš”ì†Œë¥¼ ì˜ëª» ìˆ˜ì •í•  ì¼ì´ ì—†ìŒì„ ì‹ ë¢°í•œë‹¤ë©´ ë°©ì–´ì  ë³µì‚¬ ë§ê³  ë¬¸ì„œí™”ë¥¼ í†µí•´ í™•ì‹¤íˆ ê¸°ì¬í•˜ì.
```